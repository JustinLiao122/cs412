
{% extends 'project/base.html' %}

{% block content %}





<table>
    <tr>
        <td>
            <p>Customer: {{order.customer}}</p>
        </td>
        <td>
            <p>Total Price: {{order.total_price|floatformat:2}}</p>
        </td>
        <td>
            <form action="{% url 'SplitRoute' order.id %}" method="POST">
                {% csrf_token %}
                <label for="num_splits"><p>Split between how many people?</p></label>
                <input type="number" name="num_splits" min="1" max="10" required>
                <button type="submit">Split</button>
              </form>
        </td>
        <td>
            <form action="{% url 'reorder' order.id %}" method="POST">
                {% csrf_token %}
                <button type="submit">Reorder</button>
              </form>
        </td>
    </tr>
</table>
<table>
    <tr>
        {% if "splits" in order.routes %}
        {% for route, store in order.routes.splits.items %}
        <td>
            <form action="{% url 'PastOrder' order.id %}" method="GET">
                {% csrf_token %}
                <input type="hidden" name="selected_route" value="{{ route }}">
                <button type="submit">
                  {{ route|capfirst }}
                </button>
              </form>
        </td>
        {% endfor %}
        {% endif %}
    </tr>
</table>

{% for store, values in selected_route.items %}
<table>
    <thead>
        <tr>
            <th colspan="2">
                <p>Store: {{ store }}</p>
            </th>
        </tr>
        <tr>
            <th><p>Aisle</p></th>
            <th><p>Items</p></th>
        </tr>
    </thead>
    <tbody>
        {% for aisle, items in values.aisles.items %}
        <tr>
            <td>
                <p>{{ aisle }}</p>
            </td>
            <td>
                {% if items %}
                    <ul>
                        {% for item in items %}
                            <li><p>{{ item }}</p></li>
                        {% endfor %}
                    </ul>
                {% else %}
                <ul><li><p>No items</p></li></ul>
                    
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!--converts my context variables into valid json so I can use in javascript with d3-->
{{ layout|json_script:"layout-data" }}
{{ route|json_script:"route-data" }}
{{ path|json_script:"path-data" }}

<svg id="storeMap" width="1200" height="420"></svg>

<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
const SwitchStart = "{% url 'SwitchStart' order.id %}";
const PastOrder = "{% url 'PastOrder' order.id %}";
const selectedRoute = "{{ selected_route_name }}";

function getCSRFToken() {
    const cookie = document.cookie.split("; ").find(row => row.startsWith("csrftoken="));
    return cookie ? cookie.split("=")[1] : "";
}

const storeLayout = JSON.parse(document.getElementById('layout-data').textContent);
const route = JSON.parse(document.getElementById('route-data').textContent);   // aisle names
const path = JSON.parse(document.getElementById('path-data').textContent);     // list of coordinates

const cellSize = 30;
const svg = d3.select("#storeMap");
const aisleCoords = {};

// Draw the grid and circles
storeLayout.forEach((row, y) => {
    row.forEach((cell, x) => {
        const px = x * cellSize;
        const py = y * cellSize;

        svg.append("rect")
            .attr("x", px)
            .attr("y", py)
            .attr("width", cellSize)
            .attr("height", cellSize)
            .attr("fill", cell === -1 ? "#000000" : "#f3f4f6")
            .attr("stroke", "#ccc");

        if (cell !== -1 && cell !== 0) {
            aisleCoords[cell] = [x, y];

            const circle = svg.append("circle")
                .attr("cx", px + cellSize / 2)
                .attr("cy", py + cellSize / 2)
                .attr("r", 20)
                .attr("fill", route.includes(cell) ? "#007bff" : "#6b7280");  

            if (cell === "Main" || cell === "Back") {
                circle
                    .style("cursor", "pointer")
                    .attr("fill", "#14532d")
                    .on("click", () => {
                        fetch(`${SwitchStart}?start=${cell}&selected_route=${selectedRoute}`, {
                            method: "POST",
                            headers: { "X-CSRFToken": getCSRFToken() }
                        }).then(() => {
                            window.location.href = `${PastOrder}?selected_route=${selectedRoute}`;
                        });
                    });
            }

            svg.append("text")
                .attr("x", px + cellSize / 2)
                .attr("y", py + cellSize / 2 + 4)
                .attr("text-anchor", "middle")
                .attr("font-size", "12px")
                .attr("fill", "white")
                .text(cell);
        }
    });
});

for (let i = 0; i < path.length - 1; i++) {
    const [y1, x1] = path[i];
    const [y2, x2] = path[i + 1];

    svg.append("line")
        .attr("x1", x1 * cellSize + cellSize / 2)
        .attr("y1", y1 * cellSize + cellSize / 2)
        .attr("x2", x2 * cellSize + cellSize / 2)
        .attr("y2", y2 * cellSize + cellSize / 2)
        .attr("stroke", "#007bff")
        .attr("stroke-width", 4)
        .attr("stroke-linecap", "round");
}
</script>
    
    {% endfor %}
  

{% endblock %}